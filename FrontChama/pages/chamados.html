<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chamados</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Fontes e √≠cones -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="chamados.css" />
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-inner">
            <div class="brand">
                <div class="logo-wrapper">
                    <img src="assets/logo.png" alt="Logo Chama F√°cil" class="brand-logo">
                </div>
                <span class="brand-title">Chama F√°cil</span>
            </div>

            <!-- Menu superior -->
            <nav class="main-nav" aria-label="Menu principal">
                <a class="nav-link active" href="faq.html">Central de Solu√ß√µes</a>
                <a class="nav-link" href="artigos.html">Artigos & Documentos</a>
            </nav>

            <div class="profile-area" title="Perfil">
                <i class="fa-solid fa-user-circle"></i>
            </div>
        </div>
    </header>

    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <ul>
                <li><a href="atividades.html"><i class="fa-solid fa-list-check"></i> Minhas Atividades</a></li>
                <li class="active"><a href="chamados.html"><i class="fa-solid fa-headset"></i> Chamados</a></li>
                <li><a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a></li>
                <li><a href="home.html"><i class="fa-solid fa-clipboard-list"></i> Sair</a></li>
            </ul>
        </aside>

        <!-- Conte√∫do principal -->
        <main class="page">
            <h1 class="hero-title">Central de Chamados</h1>

            <!-- Seletor de se√ß√µes -->
            <div class="search-area">
                <button class="nav-btn active" data-section="novo-chamado">+ Novo Chamado</button>
                <button class="nav-btn" data-section="pendentes">Pendentes</button>
                <button class="nav-btn" data-section="concluidos">Conclu√≠dos</button>
            </div>

            <!-- SE√á√ÉO: Novo Chamado -->
            <section id="novo-chamado" class="chamado-section faq-section active">
                <h2>Abrir Novo Chamado</h2>
                <form id="form-chamado" class="card">
                    <label>Categoria:</label>
                    <select class="input-select-categoria" required>
                        <option value="">Selecione...</option>
                        <option value="2">TI</option>
                        <option value="3">Equipamento</option>
                        <option value="4">Infraestrutura</option>
                    </select>

                    <label>Descri√ß√£o:</label>
                    <textarea class="input-descricao-categoria" placeholder="Descreva o problema..." required></textarea>

                    <button type="submit" class="btn-chamado">Enviar Chamado</button>
                </form>
            </section>

            <!-- SE√á√ÉO: Chamados Pendentes -->
            <section id="pendentes" class="chamado-section faq-section">
                <h2>Chamados Pendentes</h2>
                <table class="faq-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Categoria</th>
                            <th>Status</th>
                            <th>Data</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody class="chamado-tbody"></tbody>
                </table>
            </section>

            <!-- SE√á√ÉO: Chamados Conclu√≠dos -->
            <section id="concluidos" class="chamado-section faq-section">
                <h2>Chamados Conclu√≠dos</h2>
                <table class="faq-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Categoria</th>
                            <th>Status</th>
                            <th>Data</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody class="chamado-tbody"></tbody>
                </table>
            </section>

            <!-- Modal -->
            <div class="modal" id="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h3>Detalhes do Chamado</h3>
                    <p><strong>ID:</strong> <span id="modal-id"></span></p>
                    <p><strong>Categoria:</strong> <span id="modal-categoria"></span></p>
                    <p><strong>Status:</strong> <span id="modal-status"></span></p>
                    <p><strong>Descri√ß√£o:</strong> <span id="modal-descricao"></span></p>
                </div>
            </div>
        </main>
    </div>

    <!-- bot√£o e chat flutuante do Z√© Help -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- bot√£o flutuante -->
    <button id="chatToggle" class="fixed bottom-6 right-6 bg-[#3B82F6] text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-[#1E40AF] transition z-50">
        üí¨
    </button>

    <!-- modal do chat -->
    <div id="chatModal" class="hidden fixed bottom-20 right-6 w-[380px] max-w-[90%] bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden border border-gray-200 z-50">
        <!-- header -->
        <header class="flex items-center justify-between bg-[#2F374C] text-white p-3">
            <div class="flex items-center gap-3">
                <img src="zedohelp.png" class="w-9 h-9 rounded-full bg-white p-1" alt="Z√© Help">
                <div>
                    <h1 class="text-sm font-semibold leading-none">Z√© Help</h1>
                    <p class="text-xs opacity-80">Ajudante do Chama F√°cil</p>
                </div>
            </div>
            <button id="closeChat" class="text-lg font-bold hover:text-red-400 transition">√ó</button>
        </header>

        <!-- mensagens -->
        <main id="chatBox" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3">
            <div class="msg flex items-end gap-2">
                <img src="zedohelp.png" class="w-7 h-7 rounded-full" alt="Z√© Help">
                <div class="bg-[#3B82F6] text-white px-3 py-2 rounded-2xl max-w-[75%] text-sm">
                    Oi! Sou o Z√© Help üòÑ Como posso te ajudar hoje?
                </div>
            </div>
        </main>

        <!-- input -->
        <div class="flex items-center gap-2 border-t border-gray-200 p-2 bg-white">
            <input id="userInput" type="text" placeholder="Digite sua mensagem..."
                   class="flex-1 border border-gray-300 rounded-full px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#3B82F6]">
            <button id="sendBtn" class="bg-[#3B82F6] text-white px-4 py-1.5 rounded-full text-sm hover:bg-[#1E40AF] transition">Enviar</button>
        </div>
    </div>

    <footer class="site-footer">
        <div>¬©Ô∏è 2025 Chama F√°cil ‚Äî suporte: chamafacil@outlook.com</div>
    </footer>

    <script>
        const navButtons = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.chamado-section');
        let chamados = [];

        const categoriasMap = {
            2: 'TI',
            3: 'Equipamento',
            4: 'Infraestrutura'
        };

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                navButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const sectionId = btn.getAttribute('data-section');

                sections.forEach(sec => sec.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                if (sectionId === 'pendentes' || sectionId === 'concluidos') {
                    fetchChamados(sectionId);
                }
            });
        });

        const chatToggle = document.getElementById('chatToggle');
        const chatModal = document.getElementById('chatModal');
        const closeChat = document.getElementById('closeChat');
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modal = document.getElementById('modal');
        const closeModal = document.querySelector('.close');
        closeModal.addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });

        chatToggle.addEventListener('click', () => {
            chatModal.classList.toggle('hidden');
        });

        closeChat.addEventListener('click', () => {
            chatModal.classList.add('hidden');
        });

        function addMessage(text, sender) {
            const msg = document.createElement('div');
            msg.className = 'msg flex items-end gap-2';
            msg.innerHTML = sender === 'user'
                ? `<div class='ml-auto bg-gray-200 text-gray-800 px-3 py-2 rounded-2xl max-w-[75%] text-sm'>${text}</div>`
                : `<img src='zedohelp.png' class='w-7 h-7 rounded-full'>
                           <div class='bg-[#3B82F6] text-white px-3 py-2 rounded-2xl max-w-[75%] text-sm'>${text}</div>`;
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'msg flex items-end gap-2';
            typingDiv.innerHTML = `
                        <img src='zedohelp.png' class='w-7 h-7 rounded-full'>
                        <div class='bg-[#3B82F6] text-white px-3 py-2 rounded-2xl text-sm'>digitando...</div>`;
            chatBox.appendChild(typingDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
        }

        sendBtn.addEventListener('click', () => {
            const text = userInput.value.trim();
            if (!text || sendBtn.disabled) return;
            addMessage(text, 'user');
            userInput.value = '';
            sendBtn.disabled = true;
            userInput.disabled = true;

            showTypingIndicator();

            fetch('https://localhost:7271/api/ia/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    sessionId: 'usuario-chat'
                })
            })
                .then(res => {
                    if (!res.ok) throw new Error('Erro na resposta da API');
                    return res.json();
                })
                .then(data => {
                    removeTypingIndicator();
                    addMessage(data.response || 'Desculpe, n√£o entendi sua mensagem.', 'bot');
                })
                .catch(() => {
                    removeTypingIndicator();
                    addMessage('Ops! Algo deu errado ao falar com o assistente. üò¢', 'bot');
                })
                .finally(() => {
                    sendBtn.disabled = false;
                    userInput.disabled = false;
                    userInput.focus();
                });
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });

        const form = document.getElementById('form-chamado');
        const categoriaInput = document.querySelector('.input-select-categoria');
        const descricaoInput = document.querySelector('.input-descricao-categoria');

        form.addEventListener('submit', e => {
            e.preventDefault();

            if (!descricaoInput.value || !categoriaInput.value) {
                alert("Preencha todos os campos.");
                return;
            }

            const bodyRequest = {
                descricao: descricaoInput.value,
                numero_chamado: Math.floor(Math.random() * 1000),
                data_abertura: new Date().toISOString(),
                status: "Pendente",
                id_usuario: 1,
                id_categoria: parseInt(categoriaInput.value)
            };

            fetch("https://localhost:7271/api/v1/Chamado", {
                method: "POST",
                body: JSON.stringify(bodyRequest),
                headers: { "Content-Type": "application/json" }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Erro na requisi√ß√£o: " + response.status);
                    return response.json();
                })
                .then(() => {
                    alert("Chamado criado com sucesso!");
                    form.reset();
                    fetchChamados('pendentes');
                })
                .catch(err => console.error(err));
        });

        function fetchChamados(sectionId) {
            fetch("https://localhost:7271/api/v1/Chamado", {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            })
                .then(response => {
                    if (!response.ok) throw new Error("Erro na requisi√ß√£o: " + response.status);
                    return response.json();
                })
                .then(data => {
                    chamados = data;
                    populateTable(sectionId);
                })
                .catch(err => console.error(err));
        }

        function populateTable(sectionId) {
            const tbody = sectionId === 'pendentes'
                ? document.querySelector('#pendentes .chamado-tbody')
                : document.querySelector('#concluidos .chamado-tbody');
            tbody.innerHTML = "";

            const filtered = sectionId === 'pendentes'
                ? chamados.filter(c => {
                    const s = c.status.toLowerCase();
                    return s === 'pendente' || s === 'em-andamento';
                })
                : chamados.filter(c => {
                    const s = c.status.toLowerCase();
                    return s === 'concluido' || s === 'conclu√≠do';
                });

            filtered.forEach(chamado => {
                const s = chamado.status.toLowerCase();
                const statusClass = (s === 'pendente' || s === 'em-andamento') ? 'pendente' : 'concluido';

                let displayStatus;
                if (s === 'em-andamento') displayStatus = 'Em andamento';
                else if (s === 'concluido' || s === 'conclu√≠do') displayStatus = 'Conclu√≠do';
                else displayStatus = chamado.status;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                            <td>#${chamado.id_chamado ?? chamado.numero_chamado}</td>
                            <td>${categoriasMap[chamado.id_categoria] || chamado.id_categoria}</td>
                            <td><span class="status ${statusClass}">${displayStatus}</span></td>
                            <td>${new Date(chamado.data_abertura).toLocaleDateString()}</td>
                            <td><button class="detalhes-btn btn-chamado">Ver Detalhes</button></td>
                        `;
                tbody.appendChild(tr);

                const detalhesBtn = tr.querySelector('.detalhes-btn');
                detalhesBtn.addEventListener('click', () => showModal(chamado));
            });
        }

        function showModal(chamado) {
            const s = chamado.status.toLowerCase();
            let displayStatus;
            if (s === 'em-andamento') displayStatus = 'Em andamento';
            else if (s === 'concluido' || s === 'conclu√≠do') displayStatus = 'Conclu√≠do';
            else displayStatus = chamado.status;

            document.getElementById('modal-id').textContent = `#${chamado.id_chamado ?? chamado.numero_chamado}`;
            document.getElementById('modal-categoria').textContent = categoriasMap[chamado.id_categoria] || chamado.id_categoria;
            document.getElementById('modal-status').textContent = displayStatus;
            document.getElementById('modal-descricao').textContent = chamado.descricao;
            modal.style.display = 'flex';
        }

        fetchChamados('pendentes');
    </script>


</body>
</html>
