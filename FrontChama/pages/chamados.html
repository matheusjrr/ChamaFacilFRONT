<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chamados</title>
  <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="chamados.css" />
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo-wrapper">
          <img src="assets/logo.png" alt="Logo Chama Fácil" class="brand-logo">
        </div>
        <span class="brand-title">Chama Fácil</span>
      </div>
      <nav class="main-nav" aria-label="Menu principal">
        <a class="nav-link active" href="faq.html">Central de Soluções</a>
        <a class="nav-link" href="artigos.html">Artigos & Documentos</a>
      </nav>
      <div class="profile-area" title="Perfil">
        <i class="fa-solid fa-user-circle"></i>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <ul>
        <li><a href="atividades.html"><i class="fa-solid fa-list-check"></i> Minhas Atividades</a></li>
        <li class="active"><a href="chamados.html"><i class="fa-solid fa-headset"></i> Chamados</a></li>
        <li><a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a></li>
        <li><a href="home.html"><i class="fa-solid fa-clipboard-list"></i> Sair</a></li>
      </ul>
    </aside>

    <main class="page">
      <h1 class="hero-title">Central de Chamados</h1>

      <div class="search-area">
        <button class="nav-btn active" data-section="novo-chamado">+ Novo Chamado</button>
        <button class="nav-btn" data-section="pendentes">Pendentes</button>
        <button class="nav-btn" data-section="concluidos">Concluídos</button>
      </div>

      <section id="novo-chamado" class="chamado-section faq-section active">
        <h2>Abrir Novo Chamado</h2>
        <form id="form-chamado" class="card">
          <label>Categoria:</label>
          <select class="input-select-categoria" required>
            <option value="">Selecione...</option>
            <option value="2">TI</option>
            <option value="3">Equipamento</option>
            <option value="4">Infraestrutura</option>
          </select>

          <label>Descrição:</label>
          <textarea class="input-descricao-categoria" placeholder="Descreva o problema..." required></textarea>

          <button type="submit" class="btn-chamado">Enviar Chamado</button>
        </form>
      </section>

      <section id="pendentes" class="chamado-section faq-section">
        <h2>Chamados Pendentes</h2>
        <table class="faq-table">
          <thead>
            <tr><th>ID</th><th>Categoria</th><th>Status</th><th>Data</th><th>Ação</th></tr>
          </thead>
          <tbody class="chamado-tbody"></tbody>
        </table>
      </section>

      <section id="concluidos" class="chamado-section faq-section">
        <h2>Chamados Concluídos</h2>
        <table class="faq-table">
          <thead>
            <tr><th>ID</th><th>Categoria</th><th>Status</th><th>Data</th><th>Ação</th></tr>
          </thead>
          <tbody class="chamado-tbody"></tbody>
        </table>
      </section>

      <div class="modal" id="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Detalhes do Chamado</h3>
          <p><strong>ID:</strong> <span id="modal-id"></span></p>
          <p><strong>Categoria:</strong> <span id="modal-categoria"></span></p>
          <p><strong>Status:</strong> <span id="modal-status"></span></p>
          <p><strong>Descrição:</strong> <span id="modal-descricao"></span></p>
        </div>
      </div>
    </main>
  </div>

  <footer class="site-footer">
    <div>©️ 2025 Chama Fácil — suporte: chamafacil@outlook.com</div>
  </footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements safety-check
  const navButtons = Array.from(document.querySelectorAll('.nav-btn') || []);
  const sections = Array.from(document.querySelectorAll('.chamado-section') || []);
  const modal = document.getElementById('modal');
  const closeModal = document.querySelector('.close');
  const form = document.getElementById('form-chamado');
  const categoriaInput = document.querySelector('.input-select-categoria');
  const descricaoInput = document.querySelector('.input-descricao-categoria');

  const categoriasMap = { 2: 'TI', 3: 'Equipamento', 4: 'Infraestrutura' };
  let chamados = [];

  // Helper: safe console log for errors
  function logErr(err) {
    console.error('APP ERROR →', err);
  }

  // Navigation buttons
  navButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      navButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const sectionId = btn.getAttribute('data-section');
      sections.forEach(sec => sec.classList.remove('active'));
      const target = document.getElementById(sectionId);
      if (target) target.classList.add('active');

      if(sectionId === 'pendentes' || sectionId === 'concluidos') {
        fetchChamados(sectionId);
      }
    });
  });

  // Modal handlers (guarded)
  if (closeModal && modal) {
    closeModal.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
  }

  // Form submit (guarded)
  if (form && categoriaInput && descricaoInput) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        if (!descricaoInput.value.trim() || !categoriaInput.value) {
          alert("Preencha todos os campos.");
          return;
        }

        const bodyRequest = {
          descricao: descricaoInput.value.trim(),
          numero_chamado: Math.floor(Math.random() * 100000),
          data_abertura: new Date().toISOString(),
          status: "Pendente",
          id_usuario: 1,
          id_categoria: parseInt(categoriaInput.value, 10)
        };

        // Tenta enviar ao backend; se falhar, avisa e adiciona localmente para teste
        const apiUrl = "https://localhost:7271/api/v1/Chamado";
        let created = null;

        try {
          const res = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bodyRequest)
          });
          if (!res.ok) throw new Error('Status ' + res.status);
          created = await res.json();
        } catch (err) {
          // fallback: push local mock (para testar sem backend)
          logErr('POST falhou, usando mock local. Detalhe: ' + err);
          created = Object.assign({ id_chamado: bodyRequest.numero_chamado }, bodyRequest);
          // opcional: alert('Backend inacessível — salvando localmente apenas para testes.');
        }

        // Atualiza UI
        chamados.unshift(created);
        form.reset();
        populateTable('pendentes');
        alert("Chamado criado com sucesso!");
      } catch (err) {
        logErr(err);
        alert("Erro ao criar chamado. Veja o console.");
      }
    });
  } else {
    logErr('Formulário não encontrado ou campos estão faltando. Verifique IDs/classes no HTML.');
  }

  // Fetch chamados (GET) — com fallback para dados mock
  async function fetchChamados(sectionId) {
    const apiUrl = "https://localhost:7271/api/v1/Chamado";
    try {
      const res = await fetch(apiUrl, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
      if (!res.ok) throw new Error('Status ' + res.status);
      const data = await res.json();
      chamados = Array.isArray(data) ? data : [data];
    } catch (err) {
      logErr('GET falhou — usando dados mock. Detalhe: ' + err);
      // Dados mock para permitir testes sem backend
      chamados = [
        { id_chamado: 101, numero_chamado: 101, id_categoria: 2, status: 'Pendente', data_abertura: new Date().toISOString(), descricao: 'Computador não liga.' },
        { id_chamado: 102, numero_chamado: 102, id_categoria: 3, status: 'Concluido', data_abertura: new Date(Date.now()-86400000).toISOString(), descricao: 'Teclado com defeito.' }
      ];
    }
    populateTable(sectionId || 'pendentes');
  }

  // Populate table
  function populateTable(sectionId) {
    let tbody = null;
    if (sectionId === 'pendentes') tbody = document.querySelector('#pendentes .chamado-tbody');
    else tbody = document.querySelector('#concluidos .chamado-tbody');
    if (!tbody) {
      logErr('tbody alvo não encontrado para sectionId=' + sectionId);
      return;
    }
    tbody.innerHTML = '';

    const filtered = (sectionId === 'pendentes')
      ? chamados.filter(c => { const s = String(c.status || '').toLowerCase(); return s === 'pendente' || s === 'em-andamento'; })
      : chamados.filter(c => { const s = String(c.status || '').toLowerCase(); return s === 'concluido' || s === 'concluído'; });

    filtered.forEach(chamado => {
      const s = String(chamado.status || '').toLowerCase();
      const statusClass = (s === 'pendente' || s === 'em-andamento') ? 'pendente' : 'concluido';
      let displayStatus = chamado.status;
      if (s === 'em-andamento') displayStatus = 'Em andamento';
      else if (s === 'concluido' || s === 'concluído') displayStatus = 'Concluído';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>#${chamado.id_chamado ?? chamado.numero_chamado}</td>
        <td>${categoriasMap[chamado.id_categoria] || chamado.id_categoria}</td>
        <td><span class="status ${statusClass}">${displayStatus}</span></td>
        <td>${new Date(chamado.data_abertura).toLocaleDateString()}</td>
        <td><button class="detalhes-btn btn-chamado">Ver Detalhes</button></td>
      `;
      tbody.appendChild(tr);

      const detalhesBtn = tr.querySelector('.detalhes-btn');
      if (detalhesBtn) detalhesBtn.addEventListener('click', () => showModal(chamado));
    });
  }

  // Modal
  function showModal(chamado) {
    const s = String(chamado.status || '').toLowerCase();
    let displayStatus = chamado.status;
    if (s === 'em-andamento') displayStatus = 'Em andamento';
    else if (s === 'concluido' || s === 'concluído') displayStatus = 'Concluído';

    const eId = document.getElementById('modal-id');
    const eCat = document.getElementById('modal-categoria');
    const eStatus = document.getElementById('modal-status');
    const eDesc = document.getElementById('modal-descricao');

    if (eId) eId.textContent = `#${chamado.id_chamado ?? chamado.numero_chamado}`;
    if (eCat) eCat.textContent = categoriasMap[chamado.id_categoria] || chamado.id_categoria;
    if (eStatus) eStatus.textContent = displayStatus;
    if (eDesc) eDesc.textContent = chamado.descricao || '';

    if (modal) modal.style.display = 'flex';
  }

  // inicia com pendentes
  fetchChamados('pendentes');
});
</script>

</body>
</html>
