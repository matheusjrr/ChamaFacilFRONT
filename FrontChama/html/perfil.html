<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil do UsuÃ¡rio</title>

    <!-- Ãcone do site -->
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fontes e Ã­cones externos -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS local do perfil -->
    <link rel="stylesheet" href="../css/perfil.css" />
</head>

<body>

    <header class="site-header">
        <div class="header-inner">

            <div class="brand">
                <div class="logo-wrapper">
                    <img src="../assets/logo.png" alt="Logo Chama FÃ¡cil" class="brand-logo">
                </div>
                <span class="brand-title">Chama FÃ¡cil</span>
            </div>

            <nav class="main-nav" aria-label="Menu principal">
                <a class="nav-link" href="faq.html">Central de SoluÃ§Ãµes</a>
                <a class="nav-link" href="artigos.html">Artigos & Documentos</a>
            </nav>

            <div class="profile-area" title="Perfil">
                <i class="fa-solid fa-user-circle"></i>
            </div>

        </div>
    </header>

    <div class="layout">
        <aside class="sidebar">
            <ul>

                <li>
                    <a href="atividades.html">
                        <i class="fa-solid fa-list-check"></i> Minhas Atividades
                    </a>
                </li>

                <li>
                    <a href="chamados.html">
                        <i class="fa-solid fa-headset"></i> Chamados
                    </a>
                </li>

                <li class="active">
                    <a href="perfil.html">
                        <i class="fa-solid fa-user"></i> Perfil
                    </a>
                </li>

                <li>
                    <a href="javascript:void(0)" onclick="abrirModalSaida()">
                        <i class="fa-solid fa-clipboard-list"></i> Sair
                    </a>
                </li>

            </ul>
        </aside>

        <main class="page">
            <h1 class="hero-title">Meu Perfil</h1>

            <section class="perfil-card">
                <div class="foto-perfil">
                    <i class="fa-solid fa-user"></i>
                </div>

                <form class="perfil-form">

                    <label>Nome Completo:</label>
                    <input type="text" disabled>

                    <label>Funcional:</label>
                    <input type="text" placeholder="Digite seu funcional">

                    <label>Nova Senha:</label>
                    <input type="password" placeholder="Digite sua nova senha">

                    <label>Confirme a Nova Senha:</label>
                    <input type="password" placeholder="Confirme sua nova senha">

                    <button type="submit" class="btn-chamado">Salvar AlteraÃ§Ãµes</button>

                </form>
            </section>

            <footer class="site-footer">
                <div>Â© 2025 Chama FÃ¡cil â€” suporte: chamafacil@outlook.com</div>
            </footer>

        </main>
    </div>

    <!-- botÃ£o e chat flutuante -->
    <script src="https://cdn.tailwindcss.com"></script>
    <button id="chatToggle"
        class="fixed bottom-6 right-6 bg-[#3B82F6] text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-[#1E40AF] transition z-50">
        ðŸ’¬
    </button>

    <div id="chatModal"
        class="hidden fixed bottom-20 right-6 w-[380px] max-w-[90%] bg-white rounded-2xl shadow-xl flex flex-col overflow-hidden border border-gray-200 z-50">

        <header class="flex items-center justify-between bg-[#2F374C] text-white p-3">
            <div class="flex items-center gap-3">

                <img src="../assets/zehelp.png" class="w-9 h-9 rounded-full bg-white p-1" alt="ZÃ© Help">

                <div>
                    <h1 class="text-sm font-semibold leading-none">ZÃ© Help</h1>
                    <p class="text-xs opacity-80">Ajudante do Chama FÃ¡cil</p>
                </div>

            </div>
            <button id="closeChat" class="text-lg font-bold hover:text-red-400 transition">Ã—</button>
        </header>

        <main id="chatBox" class="flex-1 p-3 overflow-y-auto bg-gray-50 space-y-3">
            <div class="msg flex items-end gap-2">

                <img src="../assets/zehelp.png" class="w-7 h-7 rounded-full" alt="ZÃ© Help">

                <div class="bg-[#3B82F6] text-white px-3 py-2 rounded-2xl max-w-[75%] text-sm">
                    Oi! Sou o ZÃ© Help ðŸ˜„ Como posso te ajudar hoje?
                </div>

            </div>
        </main>

        <div class="flex items-center gap-2 border-t border-gray-200 p-2 bg-white">

            <input id="userInput"
                type="text"
                placeholder="Digite sua mensagem..."
                class="flex-1 border border-gray-300 rounded-full px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#3B82F6]">

            <button id="sendBtn"
                class="bg-[#3B82F6] text-white px-4 py-1.5 rounded-full text-sm hover:bg-[#1E40AF] transition">
                Enviar
            </button>

        </div>

    </div>

    <!-- Modal de saÃ­da customizado -->
    <div id="modalConfirm" class="modal">
        <div class="modal-content text-center">

            <h2 class="text-lg font-semibold mb-4 text-gray-800">
                Tem certeza que deseja sair?
            </h2>

            <div class="flex justify-center gap-4">

                <button id="btnConfirmarSair"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    Sair
                </button>

                <button id="btnCancelarSair"
                    class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>

            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- dados e formulario ---
            const form = document.querySelector('.perfil-form');
            const usuario = JSON.parse(sessionStorage.getItem('usuarioLogado'));

            if (!usuario) {
                alert('SessÃ£o expirada. FaÃ§a login novamente.');
                window.location.href = '../html/home.html';
                return;
            }

            // SeleÃ§Ãµes seguras (pode faltar algum input na tela; nÃ£o vamos quebrar o script)
            const nomeInput = form ? form.querySelector('input[type="text"]') : null;
            const emailInput = form ? form.querySelector('input[type="email"]') : null;
            const funcionalInput = form ? form.querySelector('input[placeholder="Digite seu funcional"]') : null;
            const novaSenhaInput = form ? form.querySelector('input[placeholder="Digite sua nova senha"]') : null;
            const confirmaSenhaInput = form ? form.querySelector('input[type="password"]') : null;

            if (nomeInput) nomeInput.value = usuario.nome_usuario || 'UsuÃ¡rio';
            if (emailInput) emailInput.value = usuario.email || '';

            // Submit do formulÃ¡rio com validaÃ§Ãµes defensivas
            if (form) {
                form.addEventListener('submit', async e => {
                    e.preventDefault();

                    if (!funcionalInput) {
                        alert('Campo funcional nÃ£o encontrado no formulÃ¡rio.');
                        return;
                    }

                    if (!funcionalInput.value.trim()) {
                        alert('Informe seu funcional.');
                        return;
                    }

                    if (!novaSenhaInput || !confirmaSenhaInput) {
                        alert('Campos de senha nÃ£o encontrados.');
                        return;
                    }

                    if (novaSenhaInput.value.trim() !== confirmaSenhaInput.value.trim()) {
                        alert('A nova senha e a confirmaÃ§Ã£o nÃ£o coincidem.');
                        return;
                    }

                    const payload = {
                        Nome_usuario: usuario.nome_usuario,
                        Funcional: funcionalInput.value.trim(),
                        Senha: novaSenhaInput.value.trim(),
                        Tipo_usuario: usuario.tipo_usuario,
                        Id_setor: usuario.id_setor
                    };

                    try {
                        const response = await fetch(
                            `https://localhost:7271/api/v1/Usuario/${usuario.id_usuario}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            alert('Senha alterada com sucesso!');
                            usuario.senha = novaSenhaInput.value.trim();
                            usuario.funcional = funcionalInput.value.trim();
                            sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
                            novaSenhaInput.value = '';
                            confirmaSenhaInput.value = '';
                            funcionalInput.value = '';
                        } else {
                            const error = await response.text();
                            alert('Erro ao alterar senha: ' + error);
                        }

                    } catch (err) {
                        console.error(err);
                        alert('Erro ao conectar com o servidor.');
                    }
                });
            }

            // CHATBOT  //
            const chatToggle = document.getElementById('chatToggle');
            const chatModal = document.getElementById('chatModal');
            const closeChat = document.getElementById('closeChat');
            const chatBox = document.getElementById('chatBox');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');

            // abre/fecha modal do chat
            chatToggle.addEventListener('click', () => {
                chatModal.classList.toggle('hidden');
            });

            // fecha modal no botÃ£o Ã—
            closeChat.addEventListener('click', () => {
                chatModal.classList.add('hidden');
            });

            // adiciona mensagem na tela
            function addMessage(text, sender) {
                const msg = document.createElement('div');
                msg.className = 'msg flex items-end gap-2';

                if (sender === 'user') {
                    msg.innerHTML = `
                        <div class='ml-auto bg-gray-200 text-gray-800 px-3 py-2 rounded-2xl max-w-[75%] text-sm'>${text}</div>
                    `;
                } else {
                    msg.innerHTML = `
                        <img src='../assets/zehelp.png' class='w-7 h-7 rounded-full'>
                        <div class='bg-[#3B82F6] text-white px-3 py-2 rounded-2xl max-w-[75%] text-sm'>${text}</div>
                    `;
                }

                chatBox.appendChild(msg);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // mostra indicador "digitando..."
            function showTyping() {
                const typing = document.createElement('div');
                typing.id = "typing";
                typing.className = 'msg flex items-end gap-2';
                typing.innerHTML = `
                        <img src='../assets/zehelp.png' class='w-7 h-7 rounded-full'>
                        <div class='bg-[#3B82F6] text-white px-3 py-2 rounded-2xl max-w-[75%] text-sm'>digitando...</div>
                    `;
                chatBox.appendChild(typing);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            // remove indicador digitando...
            function removeTyping() {
                const typing = document.getElementById("typing");
                if (typing) typing.remove();
            }

            // envia mensagem pra API da IA
            sendBtn.addEventListener('click', () => {
                const text = userInput.value.trim();
                if (!text || sendBtn.disabled) return;

                addMessage(text, "user");
                userInput.value = '';
                sendBtn.disabled = true;
                userInput.disabled = true;
                userInput.blur();

                showTyping();

                fetch('https://localhost:7271/api/ia/chat', {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            message: text,
                            sessionId: "usuario-chat"
                        })
                    })

                    .then(r => r.json())
                    .then(data => {
                        removeTyping();
                        addMessage(data.response || "Desculpe, nÃ£o entendi sua mensagem ðŸ˜¢", "bot");
                    })

                    .catch(() => {
                        removeTyping();
                        addMessage("Ops! Algo deu errado ao falar com o assistente ðŸš¨", "bot");
                    })

                    .finally(() => {
                        sendBtn.disabled = false;
                        userInput.disabled = false;
                        userInput.focus();
                        userInput.focus();
                    });
            });

            // permite enviar no ENTER
            userInput.addEventListener('keypress', e => {
                if (e.key === "Enter") sendBtn.click();
            });

            // fecha modal se clicar fora da Ã¡rea do chat
            window.addEventListener('click', e => {
                if (!chatModal.contains(e.target) && e.target !== chatToggle) {
                    chatModal.classList.add('hidden');
                }
            });

            // --- Modal de saÃ­da (robusto) ---
            const modalConfirm = document.getElementById('modalConfirm');
            const btnConfirmarSair = document.getElementById('btnConfirmarSair');
            const btnCancelarSair = document.getElementById('btnCancelarSair');

            const abrirModalSaidaLocal = () => {
                if (!modalConfirm) {
                    console.error('Modal nÃ£o encontrado no DOM.');
                    return;
                }
                modalConfirm.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                if (btnCancelarSair) btnCancelarSair.focus();
            };

            const fecharModalSaidaLocal = () => {
                if (!modalConfirm) return;
                modalConfirm.style.display = 'none';
                document.body.style.overflow = '';
            };

            window.abrirModalSaida = () => abrirModalSaidaLocal();

            if (btnCancelarSair) {
                btnCancelarSair.addEventListener('click', fecharModalSaidaLocal);
            }

            if (btnConfirmarSair) {
                btnConfirmarSair.addEventListener('click', () => {
                    sessionStorage.removeItem('usuarioLogado');
                    window.location.href = '../html/home.html';
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') fecharModalSaidaLocal();
            });
        });
    </script>

</body>

</html>