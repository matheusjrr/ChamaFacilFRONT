<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perfil do Usuário</title>

<!-- Ícone do site -->
<link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />

<!-- Fontes e ícones externos -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- CSS local do perfil -->
<link rel="stylesheet" href="../css/perfil.css" />
</head>
<body>

<header class="site-header">
    <div class="header-inner">
        <div class="brand">
            <div class="logo-wrapper">
                <img src="../assets/logo.png" alt="Logo Chama Fácil" class="brand-logo">
            </div>
            <span class="brand-title">Chama Fácil</span>
        </div>
        <nav class="main-nav" aria-label="Menu principal">
            <a class="nav-link active" href="faq.html">Central de Soluções</a>
            <a class="nav-link" href="artigos.html">Artigos & Documentos</a>
        </nav>
        <div class="profile-area" title="Perfil">
            <i class="fa-solid fa-user-circle"></i>
        </div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <ul>
            <li><a href="atividades.html"><i class="fa-solid fa-list-check"></i> Minhas Atividades</a></li>
            <li><a href="chamados.html"><i class="fa-solid fa-headset"></i> Chamados</a></li>
            <li class="active"><a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a></li>
            <li>
                    <a href="javascript:void(0)" onclick="abrirModalSaida()">
                        <i class="fa-solid fa-clipboard-list"></i> Sair
                    </a>
                </li>
        </ul>
    </aside>

    <main class="page">
        <h1 class="hero-title">Meu Perfil</h1>

        <section class="perfil-card">
            <div class="foto-perfil">
                <i class="fa-solid fa-user"></i>
            </div>

            <form class="perfil-form">
                <label>Nome Completo:</label>
                <input type="text" disabled>

                <label>Funcional:</label>
                <input type="text" placeholder="Digite seu funcional">

                <label>Nova Senha:</label>
                <input type="password" placeholder="Digite sua nova senha">

                <label>Confirme a Nova Senha:</label>
                <input type="password" placeholder="Confirme sua nova senha">

                <button type="submit" class="btn-chamado">Salvar Alterações</button>
            </form>
        </section>

        <footer class="site-footer">
            <div>© 2025 Chama Fácil — suporte: chamafacil@outlook.com</div>
        </footer>
    </main>
</div>

<!-- Modal de saída customizado -->
<div id="modalConfirm" class="modal">
    <div class="modal-content text-center">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">Tem certeza que deseja sair?</h2>
        <div class="flex justify-center gap-4">
            <button id="btnConfirmarSair" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Sair</button>
            <button id="btnCancelarSair" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- dados e formulario ---
    const form = document.querySelector('.perfil-form');
    const usuario = JSON.parse(sessionStorage.getItem('usuarioLogado'));

    if (!usuario) {
        alert('Sessão expirada. Faça login novamente.');
        window.location.href = '../html/home.html';
        return;
    }

    // Seleções seguras (pode faltar algum input na tela; não vamos quebrar o script)
    const nomeInput = form ? form.querySelector('input[type="text"]') : null;
    const emailInput = form ? form.querySelector('input[type="email"]') : null;
    const funcionalInput = form ? form.querySelector('input[placeholder="Digite seu funcional"]') : null;
    const novaSenhaInput = form ? form.querySelector('input[placeholder="Digite sua nova senha"]') : null;
    const confirmaSenhaInput = form ? form.querySelector('input[placeholder="Confirme sua nova senha"]') : null;

    if (nomeInput) nomeInput.value = usuario.nome_usuario || 'Usuário';
    if (emailInput) emailInput.value = usuario.email || '';
    if (funcionalInput) funcionalInput.value = usuario.funcional || '';

    // Submit do formulário com validações defensivas
    if (form) {
        form.addEventListener('submit', async e => {
            e.preventDefault();

            if (!funcionalInput) {
                alert('Campo funcional não encontrado no formulário.');
                return;
            }

            if (!funcionalInput.value.trim()) {
                alert('Informe seu funcional.');
                return;
            }

            if (!novaSenhaInput || !confirmaSenhaInput) {
                alert('Campos de senha não encontrados.');
                return;
            }

            if (novaSenhaInput.value.trim() !== confirmaSenhaInput.value.trim()) {
                alert('A nova senha e a confirmação não coincidem.');
                return;
            }

            const payload = {
                Nome_usuario: usuario.nome_usuario,
                Funcional: funcionalInput.value.trim(),
                Senha: novaSenhaInput.value.trim(),
                Tipo_usuario: usuario.tipo_usuario,
                Id_setor: usuario.id_setor
            };

            try {
                const response = await fetch(`https://localhost:7271/api/v1/Usuario/${usuario.id_usuario}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Senha alterada com sucesso!');
                    usuario.senha = novaSenhaInput.value.trim();
                    usuario.funcional = funcionalInput.value.trim();
                    sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
                    novaSenhaInput.value = '';
                    confirmaSenhaInput.value = '';
                    funcionalInput.value = '';
                } else {
                    const error = await response.text();
                    alert('Erro ao alterar senha: ' + error);
                }
            } catch (err) {
                console.error(err);
                alert('Erro ao conectar com o servidor.');
            }
        });
    }

    // --- Modal de saída (robusto) ---
    const modalConfirm = document.getElementById('modalConfirm');
    const btnConfirmarSair = document.getElementById('btnConfirmarSair');
    const btnCancelarSair = document.getElementById('btnCancelarSair');
    // seleciona o link "Sair" que tem onclick no HTML (fallback caso queira manter o onclick)
    const btnAbrirModalSair = document.querySelector('a[onclick="abrirModalSaida()"]');

    const abrirModalSaidaLocal = () => {
        if (!modalConfirm) {
            console.error('Modal não encontrado no DOM.');
            return;
        }
        modalConfirm.style.display = 'flex';
        // opcional: bloquear scroll da página enquanto modal aberto
        document.body.style.overflow = 'hidden';
        // colocar foco no botão cancelar para acessibilidade
        if (btnCancelarSair) btnCancelarSair.focus();
    };

    const fecharModalSaidaLocal = () => {
        if (!modalConfirm) return;
        modalConfirm.style.display = 'none';
        document.body.style.overflow = ''; // restaura scroll
    };

    // expõe a função global com o mesmo nome do seu HTML (se quiser manter onclick)
    window.abrirModalSaida = () => abrirModalSaidaLocal();

    // abre pelo link (evita o comportamento default do href)
    if (btnAbrirModalSair) {
        btnAbrirModalSair.addEventListener('click', (e) => {
            e.preventDefault();
            abrirModalSaidaLocal();
        });
    }

    // abre via chamada direta (caso algum outro código chame abrirModalSaida())
    // já feito acima com window.abrirModalSaida

    // confirmar sair: limpa session e redireciona
    if (btnConfirmarSair) {
        btnConfirmarSair.addEventListener('click', () => {
            sessionStorage.removeItem('usuarioLogado');
            // redireciona para a home
            window.location.href = '../html/home.html';
        });
    } else {
        console.warn('Botão confirmar sair não encontrado (id="btnConfirmarSair").');
    }

    // cancelar
    if (btnCancelarSair) {
        btnCancelarSair.addEventListener('click', fecharModalSaidaLocal);
    } else {
        console.warn('Botão cancelar sair não encontrado (id="btnCancelarSair").');
    }

    // fecha ao clicar fora do conteúdo do modal
    if (modalConfirm) {
        modalConfirm.addEventListener('click', (e) => {
            if (e.target === modalConfirm) fecharModalSaidaLocal();
        });
    }

    // fecha com ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            fecharModalSaidaLocal();
        }
    });
});
</script>


</body>
</html>