<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perfil do Usuário</title>

<!-- Ícone do site -->
<link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />

<!-- Fontes e ícones externos -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- CSS local do perfil -->
<link rel="stylesheet" href="../css/perfil.css" />
</head>
<body>

<header class="site-header">
    <div class="header-inner">
        <div class="brand">
            <div class="logo-wrapper">
                <img src="../assets/logo.png" alt="Logo Chama Fácil" class="brand-logo">
            </div>
            <span class="brand-title">Chama Fácil</span>
        </div>
        <nav class="main-nav" aria-label="Menu principal">
            <a class="nav-link active" href="faq.html">Central de Soluções</a>
            <a class="nav-link" href="artigos.html">Artigos & Documentos</a>
        </nav>
        <div class="profile-area" title="Perfil">
            <i class="fa-solid fa-user-circle"></i>
        </div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <ul>
            <li><a href="atividades.html"><i class="fa-solid fa-list-check"></i> Minhas Atividades</a></li>
            <li><a href="chamados.html"><i class="fa-solid fa-headset"></i> Chamados</a></li>
            <li class="active"><a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a></li>
            <li><a href="#" onclick="abrirModalSaida()"><i class="fa-solid fa-clipboard-list"></i> Sair</a></li>
        </ul>
    </aside>

    <main class="page">
        <h1 class="hero-title">Meu Perfil</h1>

        <section class="perfil-card">
            <div class="foto-perfil">
                <i class="fa-solid fa-user"></i>
            </div>

            <form class="perfil-form">
                <label>Nome Completo:</label>
                <input type="text" disabled>

                <label>E-mail:</label>
                <input type="email" disabled>

                <label>Funcional:</label>
                <input type="text" placeholder="Digite seu funcional">

                <label>Nova Senha:</label>
                <input type="password" placeholder="Digite sua nova senha">

                <label>Confirme a Nova Senha:</label>
                <input type="password" placeholder="Confirme sua nova senha">

                <button type="submit" class="btn-chamado">Salvar Alterações</button>
            </form>
        </section>

        <footer class="site-footer">
            <div>© 2025 Chama Fácil — suporte: chamafacil@outlook.com</div>
        </footer>
    </main>
</div>

<!-- Modal de saída customizado -->
<div id="modalConfirm" class="modal">
    <div class="modal-content text-center">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">Tem certeza que deseja sair?</h2>
        <div class="flex justify-center gap-4">
            <button id="btnConfirmarSair" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Sair</button>
            <button id="btnCancelarSair" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('.perfil-form');
    const usuario = JSON.parse(sessionStorage.getItem('usuarioLogado'));

    if (!usuario) {
        alert('Sessão expirada. Faça login novamente.');
        window.location.href = '../html/home.html';
        return;
    }

    const nomeInput = form.querySelector('input[type="text"]');
    const emailInput = form.querySelector('input[type="email"]');
    const funcionalInput = form.querySelector('input[placeholder="Digite seu funcional"]');
    const novaSenhaInput = form.querySelector('input[placeholder="Digite sua nova senha"]');
    const confirmaSenhaInput = form.querySelector('input[placeholder="Confirme sua nova senha"]');

    nomeInput.value = usuario.nome_usuario || 'Usuário';
    emailInput.value = usuario.email || '';
    funcionalInput.value = '';

    form.addEventListener('submit', async e => {
        e.preventDefault();

        if (!funcionalInput.value.trim()) {
            alert('Informe seu funcional.');
            return;
        }

        if (novaSenhaInput.value.trim() !== confirmaSenhaInput.value.trim()) {
            alert('A nova senha e a confirmação não coincidem.');
            return;
        }

        const payload = {
            Nome_usuario: usuario.nome_usuario,
            Funcional: funcionalInput.value.trim(),
            Senha: novaSenhaInput.value.trim(),
            Tipo_usuario: usuario.tipo_usuario,
            Id_setor: usuario.id_setor
        };

        try {
            const response = await fetch(`https://localhost:7271/api/v1/Usuario/${usuario.id_usuario}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                alert('Senha alterada com sucesso!');
                usuario.senha = novaSenhaInput.value.trim();
                usuario.funcional = funcionalInput.value.trim();
                sessionStorage.setItem('usuarioLogado', JSON.stringify(usuario));
                novaSenhaInput.value = '';
                confirmaSenhaInput.value = '';
                funcionalInput.value = '';
            } else {
                const error = await response.text();
                alert('Erro ao alterar senha: ' + error);
            }
        } catch (err) {
            console.error(err);
            alert('Erro ao conectar com o servidor.');
        }
    });

    // Modal de saída
    const modalConfirm = document.getElementById('modalConfirm');
    const btnConfirmarSair = document.getElementById('btnConfirmarSair');
    const btnCancelarSair = document.getElementById('btnCancelarSair');

    window.abrirModalSaida = () => {
        modalConfirm.style.display = 'flex';
    };

    const fecharModalSaida = () => {
        modalConfirm.style.display = 'none';
    };

    btnConfirmarSair.addEventListener('click', () => {
        sessionStorage.removeItem('usuarioLogado');
        window.location.href = '../html/home.html';
    });

    btnCancelarSair.addEventListener('click', fecharModalSaida);
});
</script>

</body>
</html>
