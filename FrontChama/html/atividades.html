<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minhas Atividades</title>

    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/atividades.css" />
</head>
<body>

<header class="site-header">
    <div class="header-inner">
        <div class="brand">
            <img src="../assets/logo.png" alt="Logo Chama Fácil" class="brand-logo">
            <span class="brand-title">Chama Fácil</span>
        </div>
        <nav class="main-nav" aria-label="Menu principal">
            <a href="faq.html" class="nav-link">Central de Soluções</a>
            <a href="artigos.html" class="nav-link">Artigos & Documentos</a>
        </nav>
        <div class="profile-area" title="Perfil">
            <a href="perfil.html"><i class="fa-solid fa-user-circle"></i></a>
        </div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <ul>
            <li><a href="atividades.html"><i class="fa-solid fa-list-check"></i> Minhas Atividades</a></li>
            <li><a href="chamados.html"><i class="fa-solid fa-headset"></i> Chamados</a></li>
            <li><a href="perfil.html"><i class="fa-solid fa-user"></i> Perfil</a></li>
            <li><a href="#" onclick="abrirModalSaida()"><i class="fa-solid fa-clipboard-list"></i> Sair</a></li>
        </ul>
    </aside>

    <main class="page">
        <h1 class="hero-title">Minhas Atividades</h1>

        <section class="cards-dashboard">
            <div class="info-card">
                <i class="fa-solid fa-headset"></i>
                <div>
                    <h3>Chamados em Aberto</h3>
                    <p id="countAbertos">0 chamados</p>
                </div>
            </div>
            <div class="info-card">
                <i class="fa-solid fa-check-circle"></i>
                <div>
                    <h3>Concluídos</h3>
                    <p id="countConcluidos">0 resolvidos</p>
                </div>
            </div>
            <div class="info-card">
                <i class="fa-solid fa-clock"></i>
                <div>
                    <h3>Pendentes</h3>
                    <p id="countPendentes">0 pendentes</p>
                </div>
            </div>
        </section>

        <section class="recent-activity">
            <h2>Atividades Recentes</h2>
            <ul id="listaRecentes"></ul>
        </section>
    </main>
</div>

<!-- Modal de saída padronizado -->
<div id="modalConfirm" class="modal">
    <div class="modal-content text-center">
        <h2>Tem certeza que deseja sair?</h2>
        <div class="flex justify-center gap-4">
            <button id="btnConfirmarSair" class="btn-sair">Sair</button>
            <button id="btnCancelarSair" class="btn-fechar">Cancelar</button>
        </div>
    </div>
</div>

<script>
const usuario = JSON.parse(sessionStorage.getItem("usuarioLogado"));
if (!usuario) {
    alert("Sessão expirada! Faça login novamente.");
    window.location.href = "home.html";
}

async function carregarAtividades() {
    try {
        const response = await fetch("https://localhost:7271/api/v1/Chamado");
        const chamados = await response.json();

        const meusChamados = chamados.filter(c => c.id_usuario === usuario.id_usuario);

        const abertos = meusChamados.filter(c => c.status.toLowerCase() === "em-andamento").length;
        const pendentes = meusChamados.filter(c => c.status.toLowerCase() === "pendente").length;
        const concluidos = meusChamados.filter(c => c.status.toLowerCase() === "concluido" || c.status.toLowerCase() === "concluído").length;

        document.getElementById("countAbertos").textContent = `${abertos} em andamento`;
        document.getElementById("countPendentes").textContent = `${pendentes} pendentes`;
        document.getElementById("countConcluidos").textContent = `${concluidos} resolvidos`;

        const lista = document.getElementById("listaRecentes");
        lista.innerHTML = "";

        const recentes = meusChamados
            .sort((a,b) => new Date(b.data_abertura) - new Date(a.data_abertura))
            .slice(0,3);

        recentes.forEach(c => {
            const icone = c.status.toLowerCase() === "concluido" || c.status.toLowerCase() === "concluído"
                ? "fa-check-circle"
                : c.status.toLowerCase() === "pendente"
                ? "fa-clock"
                : "fa-headset";

            const li = document.createElement("li");
            li.innerHTML = `<i class="fa-solid ${icone}"></i> Chamado #${c.numero_chamado} — <em>${c.descricao}</em>`;
            lista.appendChild(li);
        });

    } catch (err) {
        console.error("Erro ao carregar atividades:", err);
    }
}

carregarAtividades();

// Modal de saída
const modalConfirm = document.getElementById("modalConfirm");
const btnConfirmarSair = document.getElementById("btnConfirmarSair");
const btnCancelarSair = document.getElementById("btnCancelarSair");

window.abrirModalSaida = () => modalConfirm.style.display = "flex";
const fecharModalSaida = () => modalConfirm.style.display = "none";

btnConfirmarSair.addEventListener("click", () => {
    sessionStorage.removeItem("usuarioLogado");
    window.location.href = "home.html";
});

btnCancelarSair.addEventListener("click", fecharModalSaida);
window.addEventListener("click", e => {
    if (e.target === modalConfirm) fecharModalSaida();
});
</script>

</body>
</html>
