<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Perfil do Técnico</title>

<!-- Favicon -->
<link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />

<!-- Fonts e Ícones -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- CSS local -->
<link rel="stylesheet" href="../css/tec_perfil.css" />
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

<header class="site-header">
    <div class="header-inner">
        <div class="brand">
            <div class="logo-wrapper">
                <img src="../assets/logo.png" alt="Logo Chama Fácil" class="brand-logo">
            </div>
            <span class="brand-title">Chama Fácil</span>
        </div>
        <nav class="main-nav" aria-label="Menu principal">
            <a class="nav-link active" href="tec_faq.html">Central de Soluções - TÉCNICO</a>
        </nav>
        <div class="profile-area" title="Perfil">
            <i class="fa-solid fa-user"></i>
        </div>
    </div>
</header>

<div class="layout">
    <aside class="sidebar">
        <ul>
            <li>
                <a href="tec_faq.html">
                    <i class="fa-solid fa-headset"></i> Central de Chamados
                </a>
            </li>
            <li class="active">
                <i class="fa-solid fa-user"></i> Perfil
            </li>
            <li>
                <a href="#" onclick="abrirModalSaida()">
                    <i class="fa-solid fa-clipboard-list"></i> Sair
                </a>
            </li>
        </ul>
    </aside>

    <main class="page">
        <h1 class="hero-title text-center">Perfil Técnico</h1>

        <section class="perfil-card">
            <div class="foto-perfil">
                <i class="fa-solid fa-user"></i>
            </div>

            <form class="perfil-form flex flex-col gap-4">

                <label for="nome">Nome Completo:</label>
                <input id="nome" type="text" disabled>

                <label for="email">E-mail:</label>
                <input id="email" type="email" disabled>

                <label for="setor">Setor:</label>
                <input id="setor" type="text" disabled>

                <label for="funcional">Funcional:</label>
                <input id="funcional" type="text" placeholder="Digite sua funcional">

                <label for="senha">Nova Senha:</label>
                <input id="senha" type="password" placeholder="Digite sua nova senha">

                <label for="confirmarSenha">Confirmar Senha:</label>
                <input id="confirmarSenha" type="password" placeholder="Confirme sua nova senha">

                <button type="submit" class="btn-chamado mt-2">Salvar Alterações</button>
            </form>
        </section>
    </main>
</div>

<!-- Modal de saída -->
<div id="modalConfirm" class="modal">
    <div class="modal-content text-center">
        <h2 class="text-lg font-semibold mb-4 text-gray-800">Tem certeza que deseja sair?</h2>
        <div class="flex justify-center gap-4">
            <button id="btnConfirmarSair" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Sair</button>
            <button id="btnCancelarSair" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition">Cancelar</button>
        </div>
    </div>
</div>

<footer class="site-footer">
    <div>© 2025 Chama Fácil — suporte: chamafacil@outlook.com</div>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- Recupera dados do técnico ---
    const sessionKeys = ["tecnicoLogado", "tecnico"];
    let tecnico = null;
    for (const key of sessionKeys) {
        const raw = sessionStorage.getItem(key);
        if (raw) {
            try { tecnico = JSON.parse(raw); break; } 
            catch { continue; }
        }
    }

    if (!tecnico) {
        alert("Sessão expirada. Faça login novamente.");
        window.location.href = "home.html";
        return;
    }

    // --- Inputs ---
    const form = document.querySelector('.perfil-form');
    const nomeInput = document.getElementById("nome");
    const emailInput = document.getElementById("email");
    const setorInput = document.getElementById("setor");
    const funcionalInput = document.getElementById("funcional");
    const senhaInput = document.getElementById("senha");
    const confirmarSenhaInput = document.getElementById("confirmarSenha");

    nomeInput.value = tecnico.nome_tecnico || tecnico.nome || "";
    emailInput.value = tecnico.email_tecnico || tecnico.email || "";
    setorInput.value = tecnico.setor || "Hardware";
    funcionalInput.value = ""; // sempre vazio

    // --- Submit ---
    form.addEventListener("submit", async e => {
        e.preventDefault();

        const funcional = funcionalInput.value.trim();
        const senha = senhaInput.value.trim();
        const confirmar = confirmarSenhaInput.value.trim();

        if (!funcional) { alert("Informe sua funcional."); funcionalInput.focus(); return; }
        if (!senha || !confirmar) { alert("Preencha a nova senha e a confirmação."); return; }
        if (senha !== confirmar) { alert("A senha e confirmação não coincidem."); return; }

        const payload = {
            Nome_tecnico: tecnico.nome_tecnico || tecnico.nome || "",
            Funcional: funcional,
            Senha: senha,
            Id_setor: tecnico.id_setor || 0
        };

        try {
            const id = tecnico.id; // ✅ usa o campo correto do sessionStorage
            if (!id) { alert("ID do técnico não encontrado."); return; }

            const res = await fetch(`https://localhost:7271/api/v1/Tecnico/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("Senha alterada com sucesso!");
                tecnico.funcional = funcional;
                tecnico.senha = senha;
                sessionStorage.setItem(
                    sessionKeys.find(k => sessionStorage.getItem(k)) || "tecnicoLogado",
                    JSON.stringify(tecnico)
                );
                funcionalInput.value = "";
                senhaInput.value = "";
                confirmarSenhaInput.value = "";
            } else {
                const errorText = await res.text();
                alert("Erro ao alterar senha: " + errorText);
            }
        } catch (err) {
            console.error(err);
            alert("Erro ao conectar com o servidor.");
        }
    });

    // --- Modal de saída ---
    const modalConfirm = document.getElementById("modalConfirm");
    const btnConfirmarSair = document.getElementById("btnConfirmarSair");
    const btnCancelarSair = document.getElementById("btnCancelarSair");

    window.abrirModalSaida = () => modalConfirm.style.display = "flex";
    const fecharModal = () => modalConfirm.style.display = "none";

    btnConfirmarSair.addEventListener("click", () => {
        sessionStorage.removeItem("tecnicoLogado");
        window.location.href = "home.html";
    });
    btnCancelarSair.addEventListener("click", fecharModal);
    window.addEventListener("click", (e) => { if (e.target === modalConfirm) fecharModal(); });
});
</script>

</body>
</html>
